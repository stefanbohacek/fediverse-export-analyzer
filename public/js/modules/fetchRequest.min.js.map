{"version":3,"file":"fetchRequest.min.js","sources":["modules/fetchRequest.js"],"sourcesContent":["import sleep from '/js/modules/sleep.min.js';\n\nconst fetchRequest = async (url, platform, options) => {\n  // console.log('debug:fetchRequest', url, platform, options);\n\n  try {\n    const response = await fetch(url, options);\n    // console.log({\n    //   url,\n    //   response: {\n    //     status: response.status,\n    //     body: response.body,\n    //   }\n    // });\n    let data = await response.json();\n    let nextPage;\n\n    switch (platform) {\n      case \"mastodon\":\n      case \"hometown\":\n      case \"friendica\":\n      case \"pleroma\":\n      case \"akkoma\":\n        if (/<([^>]+)>; rel=\"next\"/g.test(response.headers.get(\"link\"))) {\n          nextPage = /<([^>]+)>; rel=\"next\"/g.exec(\n            response.headers.get(\"link\")\n          )[1];\n        }\n\n        if (nextPage) {\n          await sleep(500);\n          data = data.concat(\n            await fetchRequest(nextPage, platform, options)\n          );\n        }\n\n        break;\n      case \"misskey\":\n      case \"calckey\":\n      case \"firefish\":\n      case \"foundkey\":\n      case \"magnetar\":\n        if (data.length === window.globalConfig.misskeyFetchLimit) {\n          if (data && data.length) {\n            const lastAccount = data.slice(-1)[0];\n            let body = JSON.parse(options.body);\n            body.untilId = lastAccount.id;\n            options.body = JSON.stringify(body);\n          }\n          await sleep(500);\n          data = data.concat(\n            await fetchRequest(url, platform, options)\n          );\n        }\n        break;\n      default:\n        break;\n    }\n\n    return data;\n  } catch (error) {\n    console.log(\"fetchRequest error\", { error });\n    return [];\n  }\n};\n\nexport default fetchRequest;\n"],"names":["sleep","fetchRequest","async","url","platform","options","lastAccount","body","response","await","fetch","let","data","json","nextPage","test","headers","get","exec","concat","length","window","globalConfig","misskeyFetchLimit","slice","JSON","parse","untilId","id","stringify","error","console","log"],"mappings":"OAAOA,UAAW,2BAElB,MAAMC,aAAeC,MAAOC,EAAKC,EAAUC,KAGzC,IACE,IAsCcC,EACFC,EAvCNC,EAAWC,MAAMC,MAAMP,EAAKE,CAAO,EAQzCM,IAAIC,EAAOH,MAAMD,EAASK,KAAK,EAC3BC,EAEJ,OAAQV,GACN,IAAK,WACL,IAAK,WACL,IAAK,YACL,IAAK,UACL,IAAK,UAEDU,EADE,yBAAyBC,KAAKP,EAASQ,QAAQC,IAAI,MAAM,CAAC,EACjD,yBAAyBC,KAClCV,EAASQ,QAAQC,IAAI,MAAM,CAC7B,EAAE,GAGAH,KACFL,MAAMT,MAAM,GAAG,EACfY,EAAOA,EAAKO,OACVV,MAAMR,aAAaa,EAAUV,EAAUC,CAAO,CAChD,GAGF,MACF,IAAK,UACL,IAAK,UACL,IAAK,WACL,IAAK,WACL,IAAK,WACCO,EAAKQ,SAAWC,OAAOC,aAAaC,oBAClCX,GAAQA,EAAKQ,SACTd,EAAcM,EAAKY,MAAM,CAAC,CAAC,EAAE,IAC/BjB,EAAOkB,KAAKC,MAAMrB,EAAQE,IAAI,GAC7BoB,QAAUrB,EAAYsB,GAC3BvB,EAAQE,KAAOkB,KAAKI,UAAUtB,CAAI,GAEpCE,MAAMT,MAAM,GAAG,EACfY,EAAOA,EAAKO,OACVV,MAAMR,aAAaE,EAAKC,EAAUC,CAAO,CAC3C,EAKN,CAEA,OAAOO,CAIT,CAHE,MAAOkB,GAEP,OADAC,QAAQC,IAAI,qBAAsB,CAAEF,MAAAA,CAAM,CAAC,EACpC,EACT,CACF,iBAEe7B"}