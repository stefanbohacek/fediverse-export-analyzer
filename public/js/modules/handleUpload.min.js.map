{"version":3,"file":"handleUpload.min.js","sources":["modules/handleUpload.js"],"sourcesContent":["import sortArrayOfObjects from \"/js/modules/sortArrayOfObjects.min.js\";\r\nimport getDomain from \"/js/modules/getDomain.min.js\";\r\nimport loadEmbedScript from \"/js/modules/loadEmbedScript.min.js\";\r\nimport Cookie from \"/js/cookies/main.min.js\";\r\n\r\nconst cookieManager = new Cookie();\r\nconst fileInput = document.getElementById(\"file-input\");\r\nconst introElement = document.getElementById(\"intro\");\r\nconst loadingAnimation = document.getElementById(\"loading-animation\");\r\nconst loadingText = document.getElementById(\"loading-text\");\r\nconst resultsElement = document.getElementById(\"results\");\r\nconst userInfo = document.getElementById(\"user-info\");\r\nconst userAvatar = document.getElementById(\"user-avatar\");\r\nconst userDescription = document.getElementById(\"user-description\");\r\nconst userDataBreakdown = document.getElementById(\"user-data-breakdown\");\r\nconst chartElement = document.getElementById(\"chart\");\r\n\r\nconst handleUpload = () => {\r\n  if (fileInput) {\r\n    fileInput.addEventListener(\"change\", async (ev) => {\r\n      loadingAnimation.classList.remove(\"d-none\");\r\n      loadingText.classList.remove(\"d-none\");\r\n      fileInput.disabled = true;\r\n      const formData = new FormData();\r\n      formData.set(\"archive\", fileInput.files[0]);\r\n\r\n      const resp = await fetch(\"/extract-data\", {\r\n        method: \"POST\",\r\n        body: formData,\r\n      });\r\n\r\n      const response = await resp.json();\r\n\r\n      if (response && response.data) {\r\n        introElement.classList.add(\"d-none\");\r\n        resultsElement.classList.remove(\"d-none\");\r\n        const userData = response.data;\r\n\r\n        // let userDomain = getDomain(userData.actor.id);\r\n        let userDescriptionHTML = \"\";\r\n        let userDataBreakdownHTML = \"\";\r\n\r\n        if (userData.actor) {\r\n          userDescriptionHTML += `\r\n          <p class=\"mb-0\">\r\n            <strong>${\r\n              userData.actor.name || userData.actor.preferredUsername\r\n            }</strong>\r\n          </p>\r\n          ${userData.actor.summary.replaceAll('class=\"invisible\"', \"\")}\r\n          `;\r\n\r\n          if (userData.actor.attachment) {\r\n            userDescriptionHTML += `\r\n            <ul class=\"list-group\">\r\n              ${userData.actor.attachment\r\n                .map(\r\n                  (attachment) => `\r\n                <li class=\"list-group-item\">${\r\n                  attachment.name\r\n                }: ${attachment.value.replace('class=\"invisible\"', \"\")}</li>\r\n              `\r\n                )\r\n                .join(\"\")}\r\n            </ul>\r\n            `;\r\n          }\r\n\r\n          userDescription.innerHTML = `<div>${userDescriptionHTML}</div>`;\r\n\r\n          if (userData.avatar_url) {\r\n            userAvatar.innerHTML = `\r\n              <img class=\"img-thumbnail\" width=\"64\" height=\"64\" src=\"${userData.avatar_url}\">\r\n            `;\r\n          } else if (userData.avatar) {\r\n            userAvatar.innerHTML = `\r\n              <img class=\"img-thumbnail\" width=\"64\" height=\"64\" src=\"data:image/jpg;base64,${userData.avatar}\">\r\n            `;\r\n          }\r\n        } else {\r\n          userInfo.remove();\r\n          userDescription.remove();\r\n        }\r\n\r\n        let posts = [],\r\n          firstPost,\r\n          postCount = 0;\r\n\r\n        if (userData?.outbox?.orderedItems) {\r\n          posts = userData.outbox.orderedItems;\r\n        } else if (userData?.outbox) {\r\n          posts = userData.outbox;\r\n        }\r\n\r\n        postCount = posts.length;\r\n        let milestones = [];\r\n\r\n        if (postCount) {\r\n          // posts = sortArrayOfObjects(posts, key, desc)\r\n          const maxRoot = Math.ceil(Math.pow(posts.length, 1 / 10));\r\n          firstPost = posts[0];\r\n\r\n          if (posts.length >= 10) {\r\n            for (let i = 1; i <= maxRoot; i++) {\r\n              const post = posts[Math.pow(10, i)];\r\n              const url = post.id.replace(\"/activity\", \"\");\r\n\r\n              let milestone = {};\r\n              let isBoost = false;\r\n\r\n              if (!post.object.id) {\r\n                isBoost = true;\r\n              }\r\n\r\n              milestone = {\r\n                label: [`${Math.pow(10, i).toLocaleString()}th post`],\r\n                url,\r\n                isBoost,\r\n              };\r\n\r\n              milestones.push(milestone);\r\n            }\r\n          }\r\n        }\r\n\r\n        const options = {\r\n          weekday: \"long\",\r\n          year: \"numeric\",\r\n          month: \"long\",\r\n          day: \"numeric\",\r\n        };\r\n\r\n        if (userData.actor) {\r\n          const accountCreationDate = moment(userData.actor.published);\r\n          const today = moment();\r\n          const timeAgo = today.diff(accountCreationDate, \"days\");\r\n\r\n          userDataBreakdownHTML += `\r\n          <p>\r\n            You created your account on <strong>${new Date(\r\n              userData.actor.published\r\n            ).toLocaleDateString(\r\n              undefined,\r\n              options\r\n            )}</strong>, which is <strong>${timeAgo.toLocaleString()} day(s) ago</strong>. Since then, you posted <strong>${postCount.toLocaleString()} times</strong>, or about ${Math.round(\r\n            postCount / timeAgo\r\n          ).toLocaleString()} time(s) a day on average.\r\n          </p>\r\n          `;\r\n        }\r\n\r\n        let instanceURL;\r\n\r\n        if (firstPost) {\r\n          let postURL;\r\n          let url;\r\n\r\n          if ([\"firefish\", \"calckey\", \"misskey\"].includes(userData.format)) {\r\n            // Export file doesn't contain server name.\r\n          } else {\r\n            postURL = firstPost?.uri || firstPost?.object?.id || firstPost?.id;\r\n\r\n            try {\r\n              url = new URL(postURL);\r\n            } catch (err) {\r\n              console.log(\"error parsing data file\", err);\r\n            }\r\n\r\n            if (url && url.protocol && url.hostname) {\r\n              instanceURL = `${url.protocol}//${url.hostname}`;\r\n            }\r\n\r\n            userDataBreakdownHTML += `\r\n              <p>\r\n                Here's your <a href=\"${postURL}\" target=\"_blank\">first post</a>!\r\n              </p>\r\n            `;\r\n\r\n            if (userData.format === \"mastodon\") {\r\n              userDataBreakdownHTML += `\r\n              <iframe\r\n                src=\"${postURL}/embed\"\r\n                class=\"mastodon-embed\"\r\n                style=\"max-width: 100%; border: 0\" width=\"400\"\r\n                allowfullscreen=\"allowfullscreen\"></iframe>\r\n            `;\r\n            }\r\n\r\n            if (milestones && milestones.length) {\r\n              userDataBreakdownHTML += `\r\n                <p class=\"mt-3\">\r\n                  Here are more of your milestones:\r\n                </p>\r\n                <ul>\r\n                ${milestones\r\n                  .map(\r\n                    (milestone) => `\r\n                  <li>\r\n                    <a target=\"_blanlk\" href=\"${milestone.url}\">${\r\n                      milestone.label\r\n                    }</a>${milestone.isBoost ? ` (boost)` : \"\"}\r\n                  </li>\r\n                `\r\n                  )\r\n                  .join(\"\")}\r\n                </ul>\r\n              `;\r\n            }\r\n\r\n            userDataBreakdownHTML += `\r\n              <p class=\"mt-4\">\r\n                And this is what your posting history looks like.\r\n              </p>\r\n            `;\r\n          }\r\n        }\r\n\r\n        userDataBreakdown.innerHTML = userDataBreakdownHTML;\r\n\r\n        if (userData.format === \"mastodon\") {\r\n          loadEmbedScript(instanceURL);\r\n        }\r\n\r\n        // chartOptions.options.legend = {\r\n        //     display: false\r\n        // };\r\n\r\n        const data = {\r\n          labels: posts.map((post) =>\r\n            moment(post.published || post.createdAt || post.created)\r\n          ),\r\n          datasets: [\r\n            {\r\n              label: \"Your posts in time\",\r\n              data: posts.map((post, index) => {\r\n                return {\r\n                  x: moment(post.published || post.createdAt || post.created),\r\n                  // y: (new Date(post.published || post.createdAt)).getHour() + 1,\r\n                  y: new Date(\r\n                    post.published || post.createdAt || post.created\r\n                  ).getHours(),\r\n                };\r\n              }),\r\n              backgroundColor: [\"#ff6384\"],\r\n            },\r\n          ],\r\n        };\r\n\r\n        new Chart(chartElement, {\r\n          type: \"scatter\",\r\n          data: data,\r\n          options: {\r\n            scales: {\r\n              x: {\r\n                type: \"time\",\r\n                position: \"bottom\",\r\n                ticks: {\r\n                  beginAtZero: false,\r\n                  stepSize: 10,\r\n                },\r\n              },\r\n              y: {\r\n                ticks: {\r\n                  beginAtZero: false,\r\n                  display: false,\r\n                },\r\n                scaleLabel: {\r\n                  display: false,\r\n                  // labelString: chartEl.dataset.axisLabelData\r\n                  // labelString: chartEl.dataset.sourceId ? window.ftfDataviz[parseInt( chartEl.dataset.sourceId )].axis_label_title : ''\r\n                  // labelString: 'Day of the month'\r\n                },\r\n                minorTickInterval: null,\r\n              },\r\n            },\r\n            plugins: {\r\n              tooltip: {\r\n                callbacks: {\r\n                  // label: (ctx) => ctx.label\r\n                  label: (ctx) => {\r\n                    // console.log(ctx);\r\n                    // console.log(posts[ctx.dataIndex].object.content);\r\n                    return ctx.label;\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        });\r\n      } else {\r\n        loadingAnimation.classList.add(\"d-none\");\r\n        loadingText.classList.add(\"d-none\");\r\n        fileInput.disabled = false;\r\n      }\r\n    });\r\n  }\r\n};\r\n\r\nexport default handleUpload;\r\n"],"names":["sortArrayOfObjects","getDomain","loadEmbedScript","Cookie","cookieManager","fileInput","document","getElementById","introElement","loadingAnimation","loadingText","resultsElement","userInfo","userAvatar","userDescription","userDataBreakdown","chartElement","handleUpload","addEventListener","async","ev","classList","remove","disabled","formData","FormData","set","files","response","await","fetch","method","body","json","data","add","userData","let","userDescriptionHTML","userDataBreakdownHTML","posts","actor","name","preferredUsername","summary","replaceAll","attachment","map","value","replace","join","innerHTML","avatar_url","avatar","firstPost","postCount","outbox","orderedItems","milestones","length","maxRoot","Math","ceil","pow","i","post","url","id","isBoost","object","milestone","label","toLocaleString","push","options","weekday","year","month","day","accountCreationDate","moment","published","timeAgo","diff","Date","toLocaleDateString","undefined","round","instanceURL","includes","format","postURL","uri","URL","err","console","log","protocol","hostname","labels","createdAt","created","datasets","index","x","y","getHours","backgroundColor","Chart","type","scales","position","ticks","beginAtZero","stepSize","display","scaleLabel","minorTickInterval","plugins","tooltip","callbacks","ctx"],"mappings":"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"}